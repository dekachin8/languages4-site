/**
 * Languages 4 Metadata Fixer Script - TEST VERSION
 * Tests metadata generation on a single file
 */

import fs from "fs";
import path from "path";
import { JSDOM } from "jsdom";
import Anthropic from "@anthropic-ai/sdk";

const CONFIG = {
  testFile: "D:\\l4-site\\blog\\l4_blog_4.28.24_CultureIdentity.html",
  outputFile: "D:\\l4-site\\blog_fixed\\l4_blog_4_28_24_CultureIdentity.html",
};

const anthropic = new Anthropic({
  apiKey: process.env.ANTHROPIC_API_KEY,
});

function hasJSONLD(html) {
  const dom = new JSDOM(html);
  const scripts = dom.window.document.querySelectorAll(
    'script[type="application/ld+json"]'
  );
  for (let script of scripts) {
    try {
      const data = JSON.parse(script.textContent);
      if (data["@type"] === "Article") return true;
    } catch (e) {}
  }
  return false;
}

function extractBasicMetadata(html) {
  const dom = new JSDOM(html);
  const doc = dom.window.document;
  const getMeta = (name) => {
    const meta = doc.querySelector(
      `meta[name="${name}"], meta[property="${name}"]`
    );
    return meta ? meta.getAttribute("content") : "";
  };
  return {
    title: getMeta("title") || doc.querySelector("title")?.textContent || "",
    description: getMeta("description") || "",
    ogImage: getMeta("og:image") || "",
    ogImageAlt: getMeta("og:image:alt") || "",
  };
}

function extractArticleContent(html) {
  const dom = new JSDOM(html);
  const doc = dom.window.document;
  const contentDiv =
    doc.querySelector(".col-lg-8") || doc.querySelector("main") || doc.body;
  const elementsToRemove = contentDiv.querySelectorAll(
    "nav, footer, script, style, .col-lg-4, aside, .sidebar"
  );
  elementsToRemove.forEach((el) => el.remove());
  return contentDiv.textContent.trim().slice(0, 8000);
}

function extractDateFromFilename(filename) {
  const match = filename.match(/(\d{1,2})_(\d{1,2})_(\d{2,4})/);
  if (match) {
    let [, month, day, year] = match;
    if (year.length === 2) {
      year = parseInt(year) > 50 ? `19${year}` : `20${year}`;
    }
    return `${year}-${month.padStart(2, "0")}-${day.padStart(2, "0")}`;
  }
  return null;
}

async function generateMetadataWithAI(articleContent, basicMeta, filename) {
  console.log("   ðŸ¤– Analyzing content with AI...");
  const dateFromFilename = extractDateFromFilename(filename);

  const prompt = `You are helping to generate SEO metadata for Indigenous language revitalization blog articles.

Article Title: ${basicMeta.title}
${basicMeta.description ? `Existing Description: ${basicMeta.description}` : ""}
${dateFromFilename ? `Publication Date: ${dateFromFilename}` : ""}

Article Content (truncated):
${articleContent}

Please generate JSON-LD metadata in this EXACT format (valid JSON only, no markdown):

{
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": "exact article title here",
  "description": "compelling 150-180 character SEO description here",
  "image": "${
    basicMeta.ogImage ||
    "https://www.languages4.com/pages/assets/img/logo_languages4.webp"
  }",
  "author": {
    "@type": "Person",
    "name": "Tim O'Hagan",
    "jobTitle": "Founder & President",
    "email": "tim@languages4.com",
    "affiliation": {
      "@type": "Organization",
      "name": "Languages 4"
    }
  },
  "publisher": {
    "@type": "Organization",
    "name": "Languages 4",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.languages4.com/pages/assets/img/logo_languages4.webp"
    }
  },
  "datePublished": "${
    dateFromFilename || new Date().toISOString().split("T")[0]
  }",
  "dateModified": "${
    dateFromFilename || new Date().toISOString().split("T")[0]
  }",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://www.languages4.com/blog/${filename}"
  },
  "keywords": [
    "keyword1",
    "keyword2"
  ]
}

IMPORTANT: Generate 10-12 highly relevant keywords about Indigenous language revitalization, cultural curriculum, and the specific topics in this article. Return ONLY valid JSON, no markdown.`;

  const message = await anthropic.messages.create({
    model: "claude-sonnet-4-20250514",
    max_tokens: 1500,
    messages: [{ role: "user", content: prompt }],
  });

  let jsonText = message.content[0].text.trim();
  if (jsonText.startsWith("```")) {
    jsonText = jsonText.replace(/```json\n?/g, "").replace(/```\n?/g, "");
  }

  const metadata = JSON.parse(jsonText);
  console.log("   âœ… Generated metadata successfully");
  return metadata;
}

function insertJSONLD(html, jsonld) {
  const headCloseIndex = html.indexOf("</head>");
  if (headCloseIndex === -1) throw new Error("Could not find </head> tag");

  const jsonldScript = `
    <!-- ===============================================-->
    <!--    JSON-LD (Generated by AI)                   -->
    <!-- ===============================================-->

    <script type="application/ld+json">
    ${JSON.stringify(jsonld, null, 2)}
    </script>

`;
  return (
    html.slice(0, headCloseIndex) + jsonldScript + html.slice(headCloseIndex)
  );
}

async function main() {
  console.log("ðŸš€ Languages 4 Metadata Fixer - TEST MODE");
  console.log("=====================================\n");

  const outputDir = path.dirname(CONFIG.outputFile);
  if (!fs.existsSync(outputDir)) {
    fs.mkdirSync(outputDir, { recursive: true });
  }

  if (!fs.existsSync(CONFIG.testFile)) {
    console.error(`âŒ Test file not found: ${CONFIG.testFile}`);
    process.exit(1);
  }

  console.log("ðŸ“– Reading file...");
  const html = fs.readFileSync(CONFIG.testFile, "utf-8");

  if (hasJSONLD(html)) {
    console.log("   âœ“ This file already has JSON-LD\n");
    process.exit(0);
  }

  console.log("   âœ“ No JSON-LD found - will generate\n");

  console.log("ðŸ“‹ Extracting metadata...");
  const basicMeta = extractBasicMetadata(html);
  console.log(`   Title: ${basicMeta.title}`);
  console.log(`   Description: ${basicMeta.description}\n`);

  console.log("ðŸ“„ Extracting article content...");
  const articleContent = extractArticleContent(html);
  console.log(`   Content length: ${articleContent.length} characters\n`);

  console.log("ðŸ¤– Generating metadata with Claude...");
  const jsonld = await generateMetadataWithAI(
    articleContent,
    basicMeta,
    path.basename(CONFIG.testFile)
  );

  console.log("\nðŸ“Š Generated Metadata:");
  console.log("=====================================");
  console.log(JSON.stringify(jsonld, null, 2));
  console.log("=====================================\n");

  console.log("ðŸ’‰ Inserting JSON-LD into HTML...");
  const updatedHtml = insertJSONLD(html, jsonld);

  console.log(`ðŸ’¾ Saving to: ${CONFIG.outputFile}`);
  fs.writeFileSync(CONFIG.outputFile, updatedHtml, "utf-8");

  console.log("\nâœ¨ Test Complete!\n");
}

main().catch((error) => {
  console.error("Fatal error:", error);
  process.exit(1);
});
