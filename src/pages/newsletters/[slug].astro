---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import ArticleHero from '../../components/ArticleHero.astro';
import SocialShare from '../../components/SocialShare.astro';

export async function getStaticPaths() {
  const newsletters = await getCollection('newsletters', ({ data }) => !data.draft);
  
  return newsletters.map((newsletter) => ({
    params: { slug: `volume-${newsletter.data.volumeNumber.toString().replace('.', '-')}` },
    props: { newsletter },
  }));
}

const { newsletter } = Astro.props;
const { volumeNumber, title, summary, pubDate, theme, newsletterUrl, coverImage, articles } = newsletter.data;

const formattedDate = new Date(pubDate).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

// Get all volumes for navigation
const allVolumes = await getCollection('newsletters', ({ data }) => !data.draft);
const sortedVolumes = allVolumes.sort((a, b) => a.data.volumeNumber - b.data.volumeNumber);

const currentIndex = sortedVolumes.findIndex(v => v.data.volumeNumber === volumeNumber);
const prevVolume = currentIndex > 0 ? sortedVolumes[currentIndex - 1] : null;
const nextVolume = currentIndex < sortedVolumes.length - 1 ? sortedVolumes[currentIndex + 1] : null;

const shareUrl = `${Astro.site}newsletters/volume-${volumeNumber.toString().replace('.', '-')}`;
const shareTitle = `${title} - Languages 4 Newsletter`;
---

<BaseLayout title={`${title} | Languages 4 Newsletter`} description={summary}>
  <!-- Hero Section -->
  <ArticleHero
    title={title}
    subtitle={`Volume ${volumeNumber} â€¢ ${formattedDate}`}
    backgroundImage={coverImage}
  />

  <!-- Newsletter Content -->
  <section class="py-12 md:py-16">
    <div class="container max-w-4xl">
      <!-- Theme Badge -->
      {theme && (
        <div class="mb-6">
          <span class="inline-block px-4 py-2 bg-accent-100 text-accent-700 rounded-full text-sm font-semibold">
            {theme}
          </span>
        </div>
      )}

      <!-- Summary Card -->
      <div class="bg-white rounded-lg shadow-brand p-8 mb-8">
        <p class="text-lg text-neutral-700 leading-relaxed">
          {summary}
        </p>
      </div>

      <!-- Articles Index -->
      <div class="bg-white rounded-lg shadow-brand p-8 mb-8">
        <h2 class="text-2xl font-display font-bold text-primary-900 mb-6 flex items-center gap-3">
          <svg class="w-6 h-6 text-accent-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
          </svg>
          In This Issue
        </h2>
        
        <ul class="space-y-4">
          {articles.map((article) => (
            <li class="border-l-4 border-primary-200 pl-4 py-2 hover:border-accent-600 transition-colors">
              <h3 class="font-semibold text-neutral-900 mb-1">{article.title}</h3>
              <p class="text-sm text-neutral-600">by {article.author}</p>
            </li>
          ))}
        </ul>
      </div>

      <!-- CTA to Read Newsletter -->
      <div class="text-center mb-12">
        <a 
          href={newsletterUrl}
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-3 px-8 py-4 bg-accent-600 text-white font-semibold rounded-lg hover:bg-accent-700 transition-all transform hover:scale-105 shadow-lg hover:shadow-xl text-lg"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
          </svg>
          Read Full Newsletter
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
          </svg>
        </a>
        <p class="text-sm text-neutral-600 mt-3">Opens in new window</p>
      </div>

      <!-- Social Share -->
      <div class="mb-12">
        <SocialShare 
          url={shareUrl}
          title={shareTitle}
        />
      </div>

      <!-- Volume Navigation -->
      <nav class="flex items-center justify-between gap-4 pt-8 border-t border-neutral-200">
        <!-- Previous Volume -->
        <div class="flex-1">
          {prevVolume ? (
            <a 
              href={`/newsletters/volume-${prevVolume.data.volumeNumber}`}
              class="inline-flex items-center gap-2 text-primary-700 hover:text-accent-600 transition-colors group"
            >
              <svg class="w-5 h-5 transform group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
              </svg>
              <span class="hidden sm:inline">Volume {prevVolume.data.volumeNumber}</span>
              <span class="sm:hidden">Prev</span>
            </a>
          ) : (
            <div></div>
          )}
        </div>

        <!-- All Volumes -->
        <div class="flex-shrink-0">
          <a 
            href="/newsletters"
            class="inline-flex items-center gap-2 px-4 py-2 bg-primary-50 text-primary-700 rounded-lg hover:bg-primary-100 transition-colors font-semibold"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
            </svg>
            All Volumes
          </a>
        </div>

        <!-- Next Volume -->
        <div class="flex-1 flex justify-end">
          {nextVolume ? (
            <a 
              href={`/newsletters/volume-${nextVolume.data.volumeNumber}`}
              class="inline-flex items-center gap-2 text-primary-700 hover:text-accent-600 transition-colors group"
            >
              <span class="hidden sm:inline">Volume {nextVolume.data.volumeNumber}</span>
              <span class="sm:hidden">Next</span>
              <svg class="w-5 h-5 transform group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
              </svg>
            </a>
          ) : (
            <div></div>
          )}
        </div>
      </nav>
    </div>
  </section>
</BaseLayout>