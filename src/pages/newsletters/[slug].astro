---
// src/pages/newsletters/[slug].astro - Single newsletter volume page
import { getCollection } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import MainLayout from '../../layouts/MainLayout.astro';
import ArticleHero from '../../components/ArticleHero.astro';
import SocialShare from '../../components/SocialShare.astro';

export const getStaticPaths: GetStaticPaths = async () => {
  const volumes = await getCollection('newsletters');
  return volumes.map((volume) => ({
    params: { slug: volume.slug },
    props: { volume },
  }));
};

const { volume } = Astro.props;
const { Content } = await volume.render();

// Get all articles for this volume
const allArticles = await getCollection('newsletter-articles', ({ data }) => {
  return data.volumeNumber === volume.data.volumeNumber && data.draft !== true;
});

// Sort articles by section order
const sortedArticles = allArticles.sort((a, b) => {
  const orderA = a.data.sectionOrder || 999;
  const orderB = b.data.sectionOrder || 999;
  return orderA - orderB;
});

// Group articles by section
const articlesBySection = sortedArticles.reduce((acc, article) => {
  const section = article.data.section;
  if (!acc[section]) acc[section] = [];
  acc[section].push(article);
  return acc;
}, {} as Record<string, typeof sortedArticles>);

// Get prev/next volumes for navigation
const allVolumes = await getCollection('newsletters', ({ data }) => data.draft !== true);
const sortedVolumes = allVolumes.sort((a, b) => a.data.volumeNumber - b.data.volumeNumber);
const currentIndex = sortedVolumes.findIndex(v => v.slug === volume.slug);
const prevVolume = currentIndex > 0 ? sortedVolumes[currentIndex - 1] : null;
const nextVolume = currentIndex < sortedVolumes.length - 1 ? sortedVolumes[currentIndex + 1] : null;

// Format date
const formattedDate = volume.data.pubDate.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

// Generate canonical URL for sharing
const canonicalURL = new URL(Astro.url.pathname, Astro.site);
---

<MainLayout 
  title={volume.data.title}
  description={volume.data.description}
  image={volume.data.coverImage}
  type="article"
  publishedTime={volume.data.pubDate.toISOString()}
>

<!-- Hero Section -->
<ArticleHero 
  title={volume.data.title}
  subtitle={`Volume ${volume.data.volumeNumber} â€¢ ${formattedDate}`}
  backgroundImage={volume.data.coverImage || '/images/newsletters/newsletters-hero.webp'}
  backgroundAlt={volume.data.coverImageAlt || `${volume.data.title} cover`}
/>

<!-- Main Content -->
<article class="bg-neutral-50 py-12 lg:pr-20 xl:pr-24">
  <div class="max-w-4xl mx-auto px-8">
    
    <!-- Volume Introduction -->
    <div class="bg-white rounded-lg shadow-brand p-8 mb-8">
      {volume.data.theme && (
        <div class="inline-block bg-accent-100 text-accent-700 text-sm font-semibold px-4 py-2 rounded-full mb-4">
          {volume.data.theme}
        </div>
      )}
      
      <div class="prose prose-lg max-w-none mb-6">
        <Content />
      </div>
      
      <!-- Social Share -->
      <SocialShare 
        title={volume.data.title}
        url={canonicalURL.toString()}
        description={volume.data.description}
      />
    </div>
    
    <!-- Table of Contents -->
    <div class="bg-white rounded-lg shadow-brand p-8 mb-8">
      <h2 class="text-2xl font-display font-bold text-primary-900 mb-6 flex items-center gap-3">
        <svg class="w-6 h-6 text-accent-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"/>
        </svg>
        In This Issue
      </h2>
      
      {sortedArticles.length === 0 ? (
        <p class="text-neutral-600 italic">Articles coming soon...</p>
      ) : (
        <div class="space-y-6">
          {Object.entries(articlesBySection).map(([section, articles]) => (
            <div>
              <h3 class="text-lg font-display font-bold text-accent-600 mb-3 uppercase tracking-wide">
                {section}
              </h3>
              <ul class="space-y-3">
                {articles.map(article => (
                  <li class="border-l-4 border-primary-200 pl-4 hover:border-accent-600 transition-colors duration-brand">
                    <a 
                      href={`/newsletters/volume-${volume.data.volumeNumber}/${article.slug}`}
                      class="block group"
                    >
                      <h4 class="font-semibold text-primary-900 group-hover:text-accent-600 transition-colors duration-brand mb-1">
                        {article.data.title}
                      </h4>
                      <p class="text-sm text-neutral-600 line-clamp-2">
                        {article.data.description}
                      </p>
                      {article.data.author && (
                        <p class="text-xs text-neutral-500 mt-1">
                          by {article.data.author}
                        </p>
                      )}
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          ))}
        </div>
      )}
    </div>
    
    <!-- Volume Navigation -->
    <nav class="flex justify-between items-center gap-4" aria-label="Volume navigation">
      {prevVolume ? (
        <a 
          href={`/newsletters/${prevVolume.slug}`}
          class="flex items-center gap-2 px-6 py-3 bg-primary-900 text-white font-semibold rounded-lg hover:bg-primary-800 transition-colors duration-brand"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
          <span class="hidden sm:inline">Volume {prevVolume.data.volumeNumber}</span>
          <span class="sm:hidden">Prev</span>
        </a>
      ) : (
        <div></div>
      )}
      
      <a 
        href="/newsletters"
        class="px-6 py-3 bg-neutral-200 text-primary-900 font-semibold rounded-lg hover:bg-neutral-300 transition-colors duration-brand"
      >
        All Volumes
      </a>
      
      {nextVolume ? (
        <a 
          href={`/newsletters/${nextVolume.slug}`}
          class="flex items-center gap-2 px-6 py-3 bg-primary-900 text-white font-semibold rounded-lg hover:bg-primary-800 transition-colors duration-brand"
        >
          <span class="hidden sm:inline">Volume {nextVolume.data.volumeNumber}</span>
          <span class="sm:hidden">Next</span>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
          </svg>
        </a>
      ) : (
        <div></div>
      )}
    </nav>
    
  </div>
</article>

</MainLayout>