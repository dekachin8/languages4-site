---
// src/pages/newsletters/[...page].astro - Paginated newsletter archive
import { getCollection } from 'astro:content';
import type { GetStaticPaths, Page } from 'astro';
import type { CollectionEntry } from 'astro:content';
import MainLayout from '../../layouts/MainLayout.astro';
import ArticleHero from '../../components/ArticleHero.astro';
import VolumeCard from '../../components/VolumeCard.astro';

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
  const allVolumes = await getCollection('newsletters', ({ data }) => data.draft !== true);
  // Sort by volume number (newest first)
  const sortedVolumes = allVolumes.sort((a, b) => b.data.volumeNumber - a.data.volumeNumber);
  
  // 12 volumes per page
  return paginate(sortedVolumes, { pageSize: 12 });
};

type Props = {
  page: Page<CollectionEntry<'newsletters'>>;
};

const { page } = Astro.props;

// Get total count for display
const allVolumes = await getCollection('newsletters', ({ data }) => data.draft !== true);
const totalVolumes = allVolumes.length;
---

<MainLayout 
  title="L4 Newsletters Archive"
  description="Browse our complete archive of Languages 4 newsletters featuring Indigenous language reclamation stories, technology updates, community spotlights, and educational resources."
>

<!-- Hero Section -->
<ArticleHero 
  title="L4 Newsletters"
  subtitle="Stay Connected with Indigenous Language Reclamation"
  backgroundImage="/images/newsletters/newsletters-hero.webp"
  backgroundAlt="Newsletter archive and community updates"
/>

<!-- Main Content Area -->
<section class="bg-neutral-50 py-12 lg:pr-20 xl:pr-24">
  <div class="max-w-7xl mx-auto px-8">
    
    <!-- Archive Header -->
    <div class="mb-12">
      <h2 class="text-3xl font-display font-bold text-primary-900 mb-4">Newsletter Archive</h2>
      <p class="text-lg text-neutral-600 max-w-3xl">
        {totalVolumes} volumes of community stories, platform updates, Indigenous language resources, and technology innovations. Published monthly to our community of language champions.
      </p>
      
    <!-- Subscribe CTA -->
    <div class="mt-6 p-6 bg-accent-50 border-l-4 border-accent-600 rounded-lg">
      <h3 class="text-xl font-display font-bold text-primary-900 mb-2">
        Subscribe to Future Issues
      </h3>
      <p class="text-neutral-700 mb-4">
        Join 300+ Indigenous educators, language champions, and community leaders receiving monthly updates on language revitalization, technology innovations, and community success stories.
      </p>
      <a 
        href="https://lp.constantcontactpages.com/sl/4kALpU5" 
        target="_blank"
        rel="noopener noreferrer"
        class="inline-block px-6 py-3 bg-accent-600 text-white font-semibold rounded-lg hover:bg-accent-700 transition-colors duration-brand"
      >
        Subscribe Now
      </a>
    </div>
    
    <!-- Volume Grid -->
    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8 mb-12">
      {page.data.map(volume => (
        <VolumeCard 
          volumeNumber={volume.data.volumeNumber}
          title={volume.data.title}
          description={volume.data.summary}
          pubDate={volume.data.pubDate}
          coverImage={volume.data.coverImage}
          coverImageAlt={volume.data.coverImageAlt}
          slug={`volume-${volume.data.volumeNumber.toString().replace('.', '-')}`}
          theme={volume.data.theme}
          featured={volume.data.featured}
        />
      ))}
    </div>
    
    <!-- Pagination Controls -->
    {(page.lastPage > 1) && (
      <nav class="flex justify-center items-center gap-4 flex-wrap" aria-label="Pagination">
        
        {/* Previous Button */}
        {page.url.prev && (
          <a 
            href={page.url.prev}
            class="px-6 py-3 bg-primary-900 text-white font-semibold rounded-lg hover:bg-primary-800 transition-colors duration-brand"
          >
            ← Previous
          </a>
        )}
        
        {/* Page Numbers */}
        <div class="flex items-center gap-2">
          {Array.from({ length: page.lastPage }, (_, i) => i + 1).map((pageNum) => (
            <a
              href={pageNum === 1 ? '/newsletters' : `/newsletters/${pageNum}`}
              class={`w-10 h-10 flex items-center justify-center rounded-lg font-semibold transition-colors duration-brand ${
                pageNum === page.currentPage
                  ? 'bg-accent-600 text-white'
                  : 'bg-white text-primary-900 hover:bg-accent-100 border border-neutral-300'
              }`}
              aria-current={pageNum === page.currentPage ? 'page' : undefined}
            >
              {pageNum}
            </a>
          ))}
        </div>
        
        {/* Next Button */}
        {page.url.next && (
          <a 
            href={page.url.next}
            class="px-6 py-3 bg-primary-900 text-white font-semibold rounded-lg hover:bg-primary-800 transition-colors duration-brand"
          >
            Next →
          </a>
        )}
      </nav>
    )}
    
    <!-- Empty State -->
    {page.data.length === 0 && (
      <div class="text-center py-16">
        <p class="text-xl text-neutral-600">No newsletters yet. Check back soon!</p>
      </div>
    )}
    
  </div>
</section>

</MainLayout>