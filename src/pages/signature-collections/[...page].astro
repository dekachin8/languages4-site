---
// src/pages/signature-collections/[...page].astro - Paginated collections listing
import { getCollection } from 'astro:content';
import type { GetStaticPaths, Page } from 'astro';
import type { CollectionEntry } from 'astro:content';
import MainLayout from '../../layouts/MainLayout.astro';
import ArticleHero from '../../components/ArticleHero.astro';
import ArticleCard from '../../components/ArticleCard.astro';
import Sidebar from '../../components/Sidebar.astro';

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
  const allPosts = await getCollection('signature-collections', ({ data }) => data.draft !== true);
  const sortedPosts = allPosts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
  
  // 12 posts per page
  return paginate(sortedPosts, { pageSize: 12 });
};

type Props = {
  page: Page<CollectionEntry<'signature-collections'>>;
};

const { page } = Astro.props;

// Get popular posts for sidebar (from all posts, not just current page)
const allPosts = await getCollection('signature-collections', ({ data }) => data.draft !== true);
const popularPosts = allPosts
  .filter(post => post.data.featured)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .slice(0, 3)
  .map(post => ({
    title: post.data.title,
    slug: post.slug,
    heroImage: post.data.heroImage,
    collection: 'signature-collections' as const,
  }));

// Get all unique tags
const allTags = [...new Set(allPosts.flatMap(post => post.data.tags))].sort();

// Get all unique series for additional context
const allSeries = [...new Set(allPosts.map(post => post.data.seriesTitle))].sort();
---

<MainLayout 
  title="Signature Collections: Language & Culture"
  description="In-depth series exploring land-based education, traditional ecological knowledge, and Indigenous language reclamation through multi-part storytelling."
>

<!-- Hero Section -->
<ArticleHero 
  title="Signature Collections: Language & Culture"
  subtitle="Land Is Our Teacher: How  îƒÄina-Based Education Supports Indigenous Language Reclamation"
  backgroundImage="/images/signature-collections/signature-collections-hero.webp"
  backgroundAlt="Traditional canoe on water with cultural practitioners"
/>

<!-- Main Content Area -->
<section class="bg-neutral-50 py-12 pr-20 md:pr-24">
  <div class="max-w-7xl mx-auto px-8">
    
    <div class="grid lg:grid-cols-3 gap-12">
      
      <!-- Main Article Grid (2 columns) -->
      <div class="lg:col-span-2">
        
        <!-- Series Info Box -->
        {allSeries.length > 0 && (
          <div class="bg-accent-50 border-l-4 border-accent-600 p-6 rounded-lg mb-8">
            <h2 class="text-xl font-display font-bold text-primary-900 mb-3">
              üìö Multi-Part Series
            </h2>
            <p class="text-neutral-700 mb-3">
              Our Signature Collections feature in-depth explorations of critical topics in Indigenous language education, told through multiple interconnected articles.
            </p>
            <div class="flex flex-wrap gap-2">
              {allSeries.map(series => (
                <span class="inline-block bg-white text-accent-700 text-sm font-semibold px-3 py-1 rounded-full border border-accent-200">
                  {series}
                </span>
              ))}
            </div>
          </div>
        )}
        
        <!-- Articles Grid -->
        <div class="grid md:grid-cols-2 gap-6 mb-12">
          {page.data.map(post => (
            <ArticleCard 
              title={post.data.title}
              description={post.data.description}
              pubDate={post.data.pubDate}
              heroImage={post.data.heroImage}
              heroImageAlt={post.data.heroImageAlt}
              slug={post.slug}
              collection="signature-collections"
              tags={post.data.tags}
              seriesTitle={post.data.seriesTitle}
              seriesOrder={post.data.seriesOrder}
            />
          ))}
        </div>
        
        <!-- Pagination Controls -->
        {(page.lastPage > 1) && (
          <nav class="flex justify-center items-center gap-4 flex-wrap" aria-label="Pagination">
            
            {/* Previous Button */}
            {page.url.prev && (
              <a 
                href={page.url.prev}
                class="px-6 py-3 bg-primary-900 text-white font-semibold rounded-lg hover:bg-primary-800 transition-colors duration-brand"
              >
                ‚Üê Previous
              </a>
            )}
            
            {/* Page Numbers */}
            <div class="flex items-center gap-2">
              {Array.from({ length: page.lastPage }, (_, i) => i + 1).map((pageNum) => (
                <a
                  href={pageNum === 1 ? '/signature-collections' : `/signature-collections/${pageNum}`}
                  class={`w-10 h-10 flex items-center justify-center rounded-lg font-semibold transition-colors duration-brand ${
                    pageNum === page.currentPage
                      ? 'bg-accent-600 text-white'
                      : 'bg-white text-primary-900 hover:bg-accent-100 border border-neutral-300'
                  }`}
                  aria-current={pageNum === page.currentPage ? 'page' : undefined}
                >
                  {pageNum}
                </a>
              ))}
            </div>
            
            {/* Next Button */}
            {page.url.next && (
              <a 
                href={page.url.next}
                class="px-6 py-3 bg-primary-900 text-white font-semibold rounded-lg hover:bg-primary-800 transition-colors duration-brand"
              >
                Next ‚Üí
              </a>
            )}
          </nav>
        )}
        
        <!-- Empty State -->
        {page.data.length === 0 && (
          <div class="text-center py-16">
            <p class="text-xl text-neutral-600">No collections yet. Check back soon!</p>
          </div>
        )}
        
      </div>
      
      <!-- Sidebar (1 column) -->
      <div class="lg:col-span-1">
        <Sidebar 
          popularArticles={popularPosts}
          tags={allTags}
          collection="signature-collections"
        />
      </div>
      
    </div>
    
  </div>
</section>

</MainLayout>