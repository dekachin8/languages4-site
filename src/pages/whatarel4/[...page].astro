---
// src/pages/whatarel4/[...page].astro - Paginated blog listing
import { getCollection } from 'astro:content';
import type { GetStaticPaths, Page } from 'astro';
import type { CollectionEntry } from 'astro:content';
import MainLayout from '../../layouts/MainLayout.astro';
import ArticleHero from '../../components/ArticleHero.astro';
import ArticleCard from '../../components/ArticleCard.astro';
import Sidebar from '../../components/Sidebar.astro';

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
  const allPosts = await getCollection('whatarel4', ({ data }) => data.draft !== true);
  const sortedPosts = allPosts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
  
  // 12 posts per page
  return paginate(sortedPosts, { pageSize: 12 });
};

type Props = {
  page: Page<CollectionEntry<'whatarel4'>>;
};

const { page } = Astro.props;

// Get popular posts for sidebar (from all posts, not just current page)
const allPosts = await getCollection('whatarel4', ({ data }) => data.draft !== true);
const popularPosts = allPosts
  .filter(post => post.data.featured)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .slice(0, 3)
  .map(post => ({
    title: post.data.title,
    slug: post.slug,
    heroImage: post.data.heroImage,
    collection: 'whatarel4' as const,
  }));

// Get all unique tags
const allTags = [...new Set(allPosts.flatMap(post => post.data.tags))].sort();
---

<MainLayout 
  title="What Are Languages 4?"
  description="Indigenous language reclamation, revitalization, preservation, and representation. Explore our articles on technology, land-based learning, and community-led language initiatives."
>

<!-- Hero Section -->
<ArticleHero 
  title="What Are Languages 4?"
  subtitle="Indigenous Language Reclamation, Revitalization, Preservation, and Representation"
  backgroundImage="/images/whatarel4/whatarel4-hero.webp"
  backgroundAlt="Mother and child learning together"
/>

<!-- Main Content Area -->
<section class="bg-neutral-50 py-12 pr-20 md:pr-24">
  <div class="max-w-7xl mx-auto px-8">
    
    <div class="grid lg:grid-cols-3 gap-12">
      
      <!-- Main Article Grid (2 columns) -->
      <div class="lg:col-span-2">
        
        <!-- Articles Grid -->
        <div class="grid md:grid-cols-2 gap-6 mb-12">
          {page.data.map(post => (
            <ArticleCard 
              title={post.data.title}
              description={post.data.description}
              pubDate={post.data.pubDate}
              heroImage={post.data.heroImage}
              heroImageAlt={post.data.heroImageAlt}
              slug={post.slug}
              collection="whatarel4"
              tags={post.data.tags}
            />
          ))}
        </div>
        
        <!-- Pagination Controls -->
        {(page.lastPage > 1) && (
          <nav class="flex justify-center items-center gap-4 flex-wrap" aria-label="Pagination">
            
            {/* Previous Button */}
            {page.url.prev && (
              <a 
                href={page.url.prev}
                class="px-6 py-3 bg-primary-900 text-white font-semibold rounded-lg hover:bg-primary-800 transition-colors duration-brand"
              >
                ← Previous
              </a>
            )}
            
            {/* Page Numbers */}
            <div class="flex items-center gap-2">
              {Array.from({ length: page.lastPage }, (_, i) => i + 1).map((pageNum) => (
                <a
                  href={pageNum === 1 ? '/whatarel4' : `/whatarel4/${pageNum}`}
                  class={`w-10 h-10 flex items-center justify-center rounded-lg font-semibold transition-colors duration-brand ${
                    pageNum === page.currentPage
                      ? 'bg-accent-600 text-white'
                      : 'bg-white text-primary-900 hover:bg-accent-100 border border-neutral-300'
                  }`}
                  aria-current={pageNum === page.currentPage ? 'page' : undefined}
                >
                  {pageNum}
                </a>
              ))}
            </div>
            
            {/* Next Button */}
            {page.url.next && (
              <a 
                href={page.url.next}
                class="px-6 py-3 bg-primary-900 text-white font-semibold rounded-lg hover:bg-primary-800 transition-colors duration-brand"
              >
                Next →
              </a>
            )}
          </nav>
        )}
        
        <!-- Empty State -->
        {page.data.length === 0 && (
          <div class="text-center py-16">
            <p class="text-xl text-neutral-600">No articles yet. Check back soon!</p>
          </div>
        )}
        
      </div>
      
      <!-- Sidebar (1 column) -->
      <div class="lg:col-span-1">
        <Sidebar 
          popularArticles={popularPosts}
          tags={allTags}
          collection="whatarel4"
        />
      </div>
      
    </div>
    
  </div>
</section>

</MainLayout>