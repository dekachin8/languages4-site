---
// src/pages/ancestors/[...page].astro - Paginated ancestors listing
import { getCollection } from 'astro:content';
import type { GetStaticPaths, Page } from 'astro';
import type { CollectionEntry } from 'astro:content';
import MainLayout from '../../layouts/MainLayout.astro';
import ArticleHero from '../../components/ArticleHero.astro';
import ArticleCard from '../../components/ArticleCard.astro';
import Sidebar from '../../components/Sidebar.astro';

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
  const allPosts = await getCollection('ancestors', ({ data }) => data.draft !== true);
  const sortedPosts = allPosts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
  
  // 12 posts per page
  return paginate(sortedPosts, { pageSize: 12 });
};

type Props = {
  page: Page<CollectionEntry<'ancestors'>>;
};

const { page } = Astro.props;

// Get popular posts for sidebar (from all posts, not just current page)
const allPosts = await getCollection('ancestors', ({ data }) => data.draft !== true);
const popularPosts = allPosts
  .filter(post => post.data.featured)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .slice(0, 3)
  .map(post => ({
    title: post.data.title,
    slug: post.slug,
    heroImage: post.data.heroImage,
    collection: 'ancestors' as const,
  }));

// Get all unique tags
const allTags = [...new Set(allPosts.flatMap(post => post.data.tags))].sort();

// Get all unique tribes for filtering context
const allTribes = [...new Set(allPosts.map(post => post.data.tribe).filter(Boolean))].sort();
---

<MainLayout 
  title="Languages 4 Generations | Indigenous Ancestors"
  description="Honoring Indigenous leaders, cultural champions, and ancestors who shaped language preservation and cultural resilience across generations."
>

<!-- Hero Section -->
<ArticleHero 
  title="Languages 4 Generations | Indigenous Ancestors"
  subtitle="Potsanaquahip (Buffalo Hump) - Comanche Chief of Resilience and Resistance"
  backgroundImage="/images/ancestors/ancestors-hero.webp"
  backgroundAlt="Traditional Indigenous dwelling with cultural landscape"
/>

<!-- Main Content Area -->
<section class="bg-neutral-50 py-12 pr-20 md:pr-24">
  <div class="max-w-7xl mx-auto px-8">
    
    <div class="grid lg:grid-cols-3 gap-12">
      
      <!-- Main Article Grid (2 columns) -->
      <div class="lg:col-span-2">
        
        <!-- Ancestors Info Box -->
        <div class="bg-accent-50 border-l-4 border-accent-600 p-6 rounded-lg mb-8">
          <h2 class="text-xl font-display font-bold text-primary-900 mb-3">
            ü™∂ Honoring Our Ancestors
          </h2>
          <p class="text-neutral-700 mb-3">
            These profiles honor Indigenous leaders, cultural champions, and visionaries whose wisdom, resistance, and dedication to their people continue to inspire language reclamation and cultural resilience today.
          </p>
          {allTribes.length > 0 && (
            <div>
              <p class="text-sm font-semibold text-neutral-600 mb-2">Nations Featured:</p>
              <div class="flex flex-wrap gap-2">
                {allTribes.map(tribe => (
                  <span class="inline-block bg-white text-accent-700 text-sm font-semibold px-3 py-1 rounded-full border border-accent-200">
                    {tribe}
                  </span>
                ))}
              </div>
            </div>
          )}
        </div>
        
        <!-- Articles Grid -->
        <div class="grid md:grid-cols-2 gap-6 mb-12">
          {page.data.map(post => (
            <ArticleCard 
              title={post.data.title}
              description={post.data.description}
              pubDate={post.data.pubDate}
              heroImage={post.data.heroImage}
              heroImageAlt={post.data.heroImageAlt}
              slug={post.slug}
              collection="ancestors"
              tags={post.data.tags}
              ancestorName={post.data.ancestorName}
              tribe={post.data.tribe}
              lifespan={post.data.lifespan}
            />
          ))}
        </div>
        
        <!-- Pagination Controls -->
        {(page.lastPage > 1) && (
          <nav class="flex justify-center items-center gap-4 flex-wrap" aria-label="Pagination">
            
            {/* Previous Button */}
            {page.url.prev && (
              <a 
                href={page.url.prev}
                class="px-6 py-3 bg-primary-900 text-white font-semibold rounded-lg hover:bg-primary-800 transition-colors duration-brand"
              >
                ‚Üê Previous
              </a>
            )}
            
            {/* Page Numbers */}
            <div class="flex items-center gap-2">
              {Array.from({ length: page.lastPage }, (_, i) => i + 1).map((pageNum) => (
                <a
                  href={pageNum === 1 ? '/ancestors' : `/ancestors/${pageNum}`}
                  class={`w-10 h-10 flex items-center justify-center rounded-lg font-semibold transition-colors duration-brand ${
                    pageNum === page.currentPage
                      ? 'bg-accent-600 text-white'
                      : 'bg-white text-primary-900 hover:bg-accent-100 border border-neutral-300'
                  }`}
                  aria-current={pageNum === page.currentPage ? 'page' : undefined}
                >
                  {pageNum}
                </a>
              ))}
            </div>
            
            {/* Next Button */}
            {page.url.next && (
              <a 
                href={page.url.next}
                class="px-6 py-3 bg-primary-900 text-white font-semibold rounded-lg hover:bg-primary-800 transition-colors duration-brand"
              >
                Next ‚Üí
              </a>
            )}
          </nav>
        )}
        
        <!-- Empty State -->
        {page.data.length === 0 && (
          <div class="text-center py-16">
            <p class="text-xl text-neutral-600">No profiles yet. Check back soon!</p>
          </div>
        )}
        
      </div>
      
      <!-- Sidebar (1 column) -->
      <div class="lg:col-span-1">
        <Sidebar 
          popularArticles={popularPosts}
          tags={allTags}
          collection="ancestors"
        />
      </div>
      
    </div>
    
  </div>
</section>

</MainLayout>