---
// Sidebar.astro - Reusable sidebar for article pages
import type { CollectionEntry } from 'astro:content';

interface Props {
  popularArticles?: Array<{
    title: string;
    slug: string;
    heroImage?: string;
    collection: 'whatarel4' | 'signature-collections' | 'ancestors';
  }>;
  tags?: Array<{ tag: string; count: number }>;
  collection: 'whatarel4' | 'signature-collections' | 'ancestors';
  archiveYears?: Array<{ year: number; count: number }>;
}

const { popularArticles = [], tags = [], collection, archiveYears = [] } = Astro.props;

// Split tags into initial and hidden
const initialTags = tags.slice(0, 15);
const hiddenTags = tags.slice(15);
const hasMoreTags = hiddenTags.length > 0;
---

<aside class="space-y-8">
  
  <!-- Popular Articles -->
  {popularArticles.length > 0 && (
    <div class="bg-white rounded-lg p-6 shadow-md border border-neutral-200">
      <h2 class="font-display text-2xl font-bold text-primary-900 mb-6 pb-3 border-b-2 border-primary-900">
        Popular Articles
      </h2>
      
      <div class="space-y-6">
        {popularArticles.map(article => (
          <a 
            href={`/${article.collection}/${article.slug}`}
            class="block group"
          >
            {article.heroImage && (
              <img 
                src={article.heroImage} 
                alt={article.title}
                class="w-full h-32 object-cover rounded-lg mb-3 group-hover:opacity-80 transition-opacity"
              />
            )}
            <h3 class="text-accent-600 font-semibold group-hover:text-accent-700 transition-colors leading-snug">
              {article.title}
            </h3>
          </a>
        ))}
      </div>
    </div>
  )}
  
  <!-- Archive -->
  {archiveYears.length > 0 && (
    <div class="bg-white rounded-lg p-6 shadow-md border border-neutral-200">
      <h2 class="font-display text-2xl font-bold text-primary-900 mb-6 pb-3 border-b-2 border-primary-900">
        Archive
      </h2>
      
      <ul class="space-y-2">
        {archiveYears.map(({ year, count }) => (
          <li>
            <a 
              href={`/${collection}/archive/${year}`}
              class="flex justify-between items-center text-accent-600 hover:text-accent-700 hover:underline transition-colors py-1"
            >
              <span class="font-semibold">{year}</span>
              <span class="text-sm text-neutral-500">({count})</span>
            </a>
          </li>
        ))}
      </ul>
    </div>
  )}
  
  <!-- Tags -->
  {tags.length > 0 && (
    <div class="bg-white rounded-lg p-6 shadow-md border border-neutral-200">
      <h2 class="font-display text-2xl font-bold text-primary-900 mb-6 pb-3 border-b-2 border-primary-900">
        Browse by Topic
      </h2>
      
      <div class="flex flex-wrap gap-2">
        {initialTags.map(({ tag, count }) => (
          <a 
            href={`/${collection}?tag=${encodeURIComponent(tag)}`}
            class="px-3 py-1 text-xs bg-neutral-100 text-neutral-700 rounded-full hover:bg-accent-600 hover:text-white transition-colors font-medium uppercase"
          >
            {tag} <span class="text-[10px] opacity-70">({count})</span>
          </a>
        ))}
        
        {/* Hidden tags - shown when expanded */}
        {hasMoreTags && (
          <div id="hidden-tags" class="hidden flex-wrap gap-2 w-full">
            {hiddenTags.map(({ tag, count }) => (
              <a 
                href={`/${collection}?tag=${encodeURIComponent(tag)}`}
                class="px-3 py-1 text-xs bg-neutral-100 text-neutral-700 rounded-full hover:bg-accent-600 hover:text-white transition-colors font-medium uppercase"
              >
                {tag} <span class="text-[10px] opacity-70">({count})</span>
              </a>
            ))}
          </div>
        )}
      </div>
      
      {/* Show More / Show Less Button */}
      {hasMoreTags && (
        <button
          id="toggle-tags"
          class="mt-4 w-full px-4 py-2 text-sm font-semibold text-accent-600 hover:text-accent-700 hover:bg-accent-50 rounded-lg transition-colors border border-accent-200"
        >
          Show More Tags (+{hiddenTags.length})
        </button>
      )}
    </div>
  )}
  
  <!-- Past Newsletter Issues -->
  <div class="bg-white rounded-lg p-6 shadow-md border border-neutral-200">
    <h2 class="font-display text-2xl font-bold text-primary-900 mb-6 pb-3 border-b-2 border-primary-900">
      Past Newsletter Issues
    </h2>
    
    <ul class="space-y-2 text-sm">
      <li><a href="/newsletters#volume-1" class="text-accent-600 hover:text-accent-700 hover:underline">Volume 1 - Platform Spotlight</a></li>
      <li><a href="/newsletters#volume-2" class="text-accent-600 hover:text-accent-700 hover:underline">Volume 2 - Shy Learner to Family Storyteller</a></li>
      <li><a href="/newsletters#volume-3" class="text-accent-600 hover:text-accent-700 hover:underline">Volume 3 - What is Scaffolded Immersion</a></li>
      <li><a href="/newsletters#volume-4" class="text-accent-600 hover:text-accent-700 hover:underline">Volume 4 - The Core Values of Languages 4</a></li>
      <li class="pt-2"><a href="/newsletters" class="text-primary-900 font-semibold hover:text-accent-600">View All Volumes â†’</a></li>
    </ul>
  </div>
  
</aside>

<script>
  function initTagToggle() {
    const toggleButton = document.getElementById('toggle-tags');
    const hiddenTags = document.getElementById('hidden-tags');
    
    if (!toggleButton || !hiddenTags) return;
    
    let isExpanded = false;
    
    toggleButton.addEventListener('click', () => {
      isExpanded = !isExpanded;
      
      if (isExpanded) {
        hiddenTags.classList.remove('hidden');
        hiddenTags.classList.add('flex');
        toggleButton.textContent = 'Show Less Tags';
      } else {
        hiddenTags.classList.add('hidden');
        hiddenTags.classList.remove('flex');
        const count = hiddenTags.querySelectorAll('a').length;
        toggleButton.textContent = `Show More Tags (+${count})`;
      }
    });
  }
  
  // Initialize on page load
  initTagToggle();
  
  // Re-initialize after View Transitions
  document.addEventListener('astro:after-swap', initTagToggle);
</script>