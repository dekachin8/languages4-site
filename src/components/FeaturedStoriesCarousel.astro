---
// FeaturedStoriesCarousel.astro - Weighted recent (70%) + legacy (30%) article showcase
import { getCollection } from 'astro:content';

// Fetch all articles from all collections
const whatarel4Posts = await getCollection('whatarel4');
const signatureCollections = await getCollection('signature-collections');
const ancestors = await getCollection('ancestors');

// Combine all posts
const allPosts = [
  ...whatarel4Posts.map(post => ({ ...post, collection: 'whatarel4', badge: 'What Are L4', badgeColor: 'bg-primary-600' })),
  ...signatureCollections.map(post => ({ ...post, collection: 'signature-collections', badge: 'Signature Collection', badgeColor: 'bg-[#005485]' })),
  ...ancestors.map(post => ({ ...post, collection: 'ancestors', badge: 'Indigenous Ancestors', badgeColor: 'bg-accent-600' }))
];

// Sort by date (newest first)
const sortedPosts = allPosts.sort((a, b) => {
  const dateA = new Date(a.data.publishDate || a.data.date || 0);
  const dateB = new Date(b.data.publishDate || b.data.date || 0);
  return dateB.getTime() - dateA.getTime();
});

// Smart fallback: Try 6 months, then 12, then 18 until we have enough posts
function getRecentAndLegacyPosts(months: number) {
  const cutoffDate = new Date();
  cutoffDate.setMonth(cutoffDate.getMonth() - months);
  
  const recent = sortedPosts.filter(post => {
    const postDate = new Date(post.data.publishDate || post.data.date || 0);
    return postDate >= cutoffDate;
  });
  
  const legacy = sortedPosts.filter(post => {
    const postDate = new Date(post.data.publishDate || post.data.date || 0);
    return postDate < cutoffDate;
  });
  
  return { recent, legacy };
}

// Try progressively longer timeframes until we have enough posts
let recentPosts: typeof allPosts = [];
let legacyPosts: typeof allPosts = [];

// Try 6 months first
let result = getRecentAndLegacyPosts(6);
recentPosts = result.recent;
legacyPosts = result.legacy;

// If not enough recent posts, try 12 months
if (recentPosts.length < 3) {
  result = getRecentAndLegacyPosts(12);
  recentPosts = result.recent;
  legacyPosts = result.legacy;
}

// If still not enough, try 18 months
if (recentPosts.length < 3) {
  result = getRecentAndLegacyPosts(18);
  recentPosts = result.recent;
  legacyPosts = result.legacy;
}

// If still not enough recent posts, treat all as legacy and pick randomly
if (recentPosts.length < 3) {
  recentPosts = [];
  legacyPosts = sortedPosts;
}

// Weighted selection: 70% recent, 30% legacy
function shuffleArray(array: any[]) {
  const shuffled = [...array];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
}

// Select 3 recent + 2 legacy (or adjust if collections are small)
const numRecent = Math.min(3, recentPosts.length);
const numLegacy = Math.min(2, legacyPosts.length);

const selectedRecent = shuffleArray(recentPosts).slice(0, numRecent);
const selectedLegacy = shuffleArray(legacyPosts).slice(0, numLegacy);

// Combine and shuffle final selection so they're not chronologically grouped
const featuredPosts = shuffleArray([...selectedRecent, ...selectedLegacy]);

// Get image path helper
function getImagePath(post: any) {
  // Try heroImage first, then fallback to image
  const imagePath = post.data.heroImage || post.data.image;
  if (!imagePath) return '/images/placeholder.jpg'; // fallback
  
  // If it's already a full path starting with /, use it
  if (imagePath.startsWith('/')) return imagePath;
  
  // Otherwise, construct path based on collection
  return `/images/${post.collection}/${imagePath}`;
}
---

<section class="relative py-16 md:py-24 bg-gradient-to-b from-white to-neutral-50 overflow-hidden">
  <!-- Background decoration -->
  <div class="absolute inset-0 opacity-5">
    <div class="absolute top-0 right-0 w-96 h-96 bg-primary-600 rounded-full blur-3xl"></div>
    <div class="absolute bottom-0 left-0 w-96 h-96 bg-accent-600 rounded-full blur-3xl"></div>
  </div>

  <div class="container mx-auto px-4 md:px-8 lg:pr-24 relative z-10">
    <!-- Section Header -->
    <div class="text-center mb-12">
      <span class="inline-block text-xs md:text-sm font-bold tracking-[2px] text-white bg-neutral-600 px-4 py-2 mb-4 rounded">FEATURED STORIES</span>
      <h2 class="font-display text-3xl md:text-5xl font-medium text-primary-900 mb-4">Explore Our Journey</h2>
      <p class="text-lg text-neutral-700 max-w-2xl mx-auto">
        Discover insights from our archives, honor Indigenous ancestors, and explore signature collections
      </p>
    </div>

    <!-- Carousel Container -->
    <div class="relative max-w-5xl mx-auto">
      <!-- Carousel Track -->
      <div id="carousel-track" class="relative h-[600px] md:h-[500px]">
        {featuredPosts.map((post, index) => {
          const imagePath = getImagePath(post);
          const url = `/${post.collection}/${post.slug}`;
          const title = post.data.title;
          const description = post.data.description || post.data.excerpt || '';
          
          return (
            <div 
              class="carousel-card absolute inset-0 transition-all duration-700 ease-in-out"
              data-index={index}
              style={index === 0 ? 'opacity: 1; transform: translateX(0) rotateY(0deg) scale(1);' : 'opacity: 0; transform: translateX(100%) rotateY(15deg) scale(0.9);'}
            >
              <div class="relative h-full bg-white rounded-2xl shadow-[0_20px_60px_rgba(0,0,0,0.15)] overflow-hidden transform transition-transform duration-300 hover:scale-[1.02] hover:shadow-[0_25px_70px_rgba(0,0,0,0.25)]">
                <!-- Hero Image with Gradient Overlay -->
                <div class="relative h-64 md:h-72 overflow-hidden">
                  <img 
                    src={imagePath} 
                    alt={title}
                    class="w-full h-full object-cover"
                  />
                  <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/20 to-transparent"></div>
                  
                  <!-- Collection Badge -->
                  <span class={`absolute top-4 left-4 ${post.badgeColor} text-white text-xs font-bold px-3 py-1.5 rounded-full shadow-lg`}>
                    {post.badge}
                  </span>
                </div>

                <!-- Content -->
                <div class="p-8 md:p-10">
                  <h3 class="font-display text-2xl md:text-3xl font-semibold text-primary-900 mb-4 leading-tight line-clamp-2">
                    {title}
                  </h3>
                  
                  <p class="text-neutral-700 text-base md:text-lg mb-6 line-clamp-3 leading-relaxed">
                    {description}
                  </p>

                  <a 
                    href={url}
                    class="inline-flex items-center gap-2 text-accent-600 font-semibold text-lg transition-all duration-300 hover:gap-3 hover:text-accent-700 group"
                  >
                    Continue Reading
                    <svg class="w-5 h-5 transition-transform duration-300 group-hover:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                    </svg>
                  </a>
                </div>

                <!-- Card Number Badge -->
                <div class="absolute bottom-4 right-4 w-12 h-12 bg-primary-900 text-white rounded-full flex items-center justify-center font-bold text-lg shadow-lg">
                  {index + 1}
                </div>
              </div>
            </div>
          );
        })}
      </div>

      <!-- Navigation Controls -->
      <div class="flex items-center justify-center gap-6 mt-8">
        <!-- Previous Button -->
        <button 
          id="prev-btn"
          class="w-12 h-12 rounded-full bg-primary-900 text-white flex items-center justify-center transition-all duration-300 hover:bg-primary-800 hover:scale-110 shadow-brand disabled:opacity-30 disabled:cursor-not-allowed"
          aria-label="Previous story"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
        </button>

        <!-- Dot Navigation -->
        <div class="flex gap-3">
          {featuredPosts.map((_, index) => (
            <button
              class="carousel-dot w-3 h-3 rounded-full transition-all duration-300"
              data-index={index}
              aria-label={`Go to story ${index + 1}`}
            ></button>
          ))}
        </div>

        <!-- Next Button -->
        <button 
          id="next-btn"
          class="w-12 h-12 rounded-full bg-primary-900 text-white flex items-center justify-center transition-all duration-300 hover:bg-primary-800 hover:scale-110 shadow-brand disabled:opacity-30 disabled:cursor-not-allowed"
          aria-label="Next story"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
          </svg>
        </button>
      </div>

      <!-- Collection Navigation Buttons -->
      <div class="flex flex-col md:flex-row gap-4 justify-center mt-12 max-w-4xl mx-auto">
        <a 
          href="/whatarel4"
          class="flex-1 py-3 px-6 border-2 border-primary-600 text-primary-600 rounded-lg font-semibold text-base md:text-lg text-center flex items-center justify-center transition-all duration-300 hover:bg-primary-600 hover:text-white hover:-translate-y-0.5 hover:shadow-brand"
        >
          View What Are L4 Articles
        </a>
        <a 
          href="/signature-collections"
          class="flex-1 py-3 px-6 border-2 border-[#005485] text-[#005485] rounded-lg font-semibold text-base md:text-lg text-center flex items-center justify-center transition-all duration-300 hover:bg-[#005485] hover:text-white hover:-translate-y-0.5 hover:shadow-brand"
        >
          Explore Signature Collections
        </a>
        <a 
          href="/ancestors"
          class="flex-1 py-3 px-6 border-2 border-accent-600 text-accent-600 rounded-lg font-semibold text-base md:text-lg text-center flex items-center justify-center transition-all duration-300 hover:bg-accent-600 hover:text-white hover:-translate-y-0.5 hover:shadow-brand"
        >
          Meet Indigenous Ancestors
        </a>
      </div>
    </div>
  </div>
</section>

<script>
  // Carousel functionality with auto-rotation
  let currentIndex = 0;
  let autoRotateInterval: number;
  const cards = document.querySelectorAll('.carousel-card') as NodeListOf<HTMLElement>;
  const dots = document.querySelectorAll('.carousel-dot') as NodeListOf<HTMLElement>;
  const prevBtn = document.getElementById('prev-btn') as HTMLButtonElement;
  const nextBtn = document.getElementById('next-btn') as HTMLButtonElement;
  const totalCards = cards.length;

  function updateCarousel(newIndex: number) {
    // Hide current card
    cards[currentIndex].style.opacity = '0';
    cards[currentIndex].style.transform = 'translateX(-100%) rotateY(-15deg) scale(0.9)';
    cards[currentIndex].style.pointerEvents = 'none';

    // Update index
    currentIndex = newIndex;

    // Show new card
    cards[currentIndex].style.opacity = '1';
    cards[currentIndex].style.transform = 'translateX(0) rotateY(0deg) scale(1)';
    cards[currentIndex].style.pointerEvents = 'auto';

    // Update dots
    dots.forEach((dot, index) => {
      if (index === currentIndex) {
        dot.classList.add('bg-accent-600', 'w-8');
        dot.classList.remove('bg-neutral-300', 'w-3');
      } else {
        dot.classList.add('bg-neutral-300', 'w-3');
        dot.classList.remove('bg-accent-600', 'w-8');
      }
    });

    // Update button states
    prevBtn.disabled = currentIndex === 0;
    nextBtn.disabled = currentIndex === totalCards - 1;
  }

  function nextSlide() {
    if (currentIndex < totalCards - 1) {
      updateCarousel(currentIndex + 1);
    }
  }

  function prevSlide() {
    if (currentIndex > 0) {
      updateCarousel(currentIndex - 1);
    }
  }

  function startAutoRotate() {
    autoRotateInterval = window.setInterval(() => {
      // Loop back to start when reaching the end
      if (currentIndex < totalCards - 1) {
        nextSlide();
      } else {
        updateCarousel(0);
      }
    }, 8000); // 8 seconds
  }

  function stopAutoRotate() {
    clearInterval(autoRotateInterval);
  }

  // Event Listeners
  prevBtn?.addEventListener('click', () => {
    prevSlide();
    stopAutoRotate();
    startAutoRotate(); // Restart timer after manual interaction
  });

  nextBtn?.addEventListener('click', () => {
    nextSlide();
    stopAutoRotate();
    startAutoRotate();
  });

  dots.forEach((dot, index) => {
    dot.addEventListener('click', () => {
      updateCarousel(index);
      stopAutoRotate();
      startAutoRotate();
    });
  });

  // Pause on hover
  const carouselSection = document.querySelector('#carousel-track');
  carouselSection?.addEventListener('mouseenter', stopAutoRotate);
  carouselSection?.addEventListener('mouseleave', startAutoRotate);

  // Initialize
  updateCarousel(0);
  startAutoRotate();

  // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowLeft') {
      prevSlide();
      stopAutoRotate();
      startAutoRotate();
    } else if (e.key === 'ArrowRight') {
      nextSlide();
      stopAutoRotate();
      startAutoRotate();
    }
  });

  // Re-initialize after View Transitions (Astro feature)
  document.addEventListener('astro:after-swap', () => {
    stopAutoRotate();
    currentIndex = 0;
    updateCarousel(0);
    startAutoRotate();
  });
</script>

<style>
  .carousel-card {
    transition: opacity 700ms ease-in-out, transform 700ms ease-in-out;
  }

  .carousel-dot {
    transition: all 300ms ease-in-out;
  }

  /* Smooth text truncation */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>